
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>微信小程序控制音视频文件播放进度的实现</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab title="微信小程序控制音视频文件播放进度的实现"
                  environment="web"
                  feedback-link="http://www.sctu.edu.cn">
    
      <google-codelab-step label="1.问题描述" duration="0">
        <p>在微信小程序中我们经常会用到控制文件播放的滑块，通过滑块可控制音视频播放进度，下面我将所实现的代码演示给大家看。</p>


      </google-codelab-step>
    
      <google-codelab-step label="2.问题分析" duration="0">
        <p>首先我们要用.ml与.ss代码实现进度条的效果，再通过.js文件控制进度条的进度和进度条的时间显示。</p>


      </google-codelab-step>
    
      <google-codelab-step label="3.问题解决" duration="0">
        <p>在.ml文件中编写播放进度结构代码：</p>
<pre><code>&lt;view class=&#34;content-play-progress&#34;&gt;
  &lt;text&gt;&#123;&#123;play.currentTime}}&lt;/text&gt;
    &lt;view&gt;
      &lt;slider activeColor=&#34;#d33a31&#34; block-size=&#34;12&#34; backgroundColor=&#34;#dadada&#34; value=&#34;&#123;&#123;play.percent}}&#34;/&gt;
    &lt;/view&gt;
  &lt;text&gt;&#123;&#123;play.duration}}&lt;/text&gt;
&lt;/view&gt;
</code></pre>
<p>在上述代码中，第五行用到了slider组件，其值为播放进度play.percent<br>在.ss中编写样式，具体代码如下:</p>
<pre><code>.content-play-progress{
  display: flex;
  align-items: center;
  margin: 0 35rpx;
  font-size: 9pt;
  text-align: center;
}
.content-play-progress&gt;view{
  flex: 1;
}
</code></pre>
<p>保存上述代码后，运行程序，效果如图：</p>
<p><img src="img/465542082501694b.png"></p>
<p>接下来在.js文件中控制进度条的进度和时间显示，具体代码如下:</p>
<pre><code>onReady: function(){
  this.audioCtx=wx.createInnerAudioContext()
  var that=this
//播放失败检测
this. audioCtx.onError(function(){
    console.log(‘播放失败：&#39;+that.audioCtx.src)
})
//播放完成自动换下一曲
this. audioCtx.OnEnded(function(){
  that.next()
})
//自动更新播放进度
this. audioCtx.onPlay(function(){
this. audioCtx.onTimeUpdate(function(){
  that.setData({
‘play.duration&#39;: formatTime(that.audioCtx.duration),
‘play.currrentTime&#39;: formatTime(that.audioCtx. currrentTime),
‘play.percent&#39;: that.audioCtx. currrentTime /
            that.audioCtx.duration*100
})
})
//默认选择第一曲
 This.setMusic(0)
  //格式化时间
function formatTime(time){
   var minute=Math.floor(time/60)%60;
var second=Math.floor(time)%60
return (minute&lt;10?&#39;0&#39;+minute:minute)+&#39;:&#39;+
     (second&lt;10?&#39;0&#39;+second:second)
}
})
}
</code></pre>
<p>上述代码中，通过调用audioCtx的onTimeUpdate()的方法，获取音视频状态信息，并通过formatTime()函数处理时间格式，最后渲染到页面实现实时更新效果，效果如图：</p>
<p><img src="img/5db5334ca877d4bf.png"></p>
<p>在slider组件上绑定bindchange事件，可以实现滑动进度条调节音视频文件播放进度，具体代码如下:</p>
<pre><code>&lt;slider bindchange=&#34;sliderChange&#34; activeColor=&#34;#d33a31&#34; block-size=&#34;12&#34; backgroundColor=&#34;#dadada&#34; value=&#34;&#123;&#123;play.percent}}&#34;/ &gt;
</code></pre>
<p>在.js文件中编写sliderChange函数获取用户当前选择的进度，将时间通过audioCtx对象的seek()方法进行设置，具体代码如下：</p>
<pre><code>sliderChange: function(e){
  var second=e.detail.value* that.audioCtx.duration/100
that.audioCtx.seek(secend)
},
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="4.总结" duration="0">
        <p>微信小程序中进度条的实现获取当前进度对.js文件的编写较为繁复，作者在编写过程中一定要多多注意。</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
