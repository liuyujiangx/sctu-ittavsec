
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>微信小程序与tensorflow.js模型引入</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab title="微信小程序与tensorflow.js模型引入"
                  environment="web"
                  feedback-link="http://www.sctu.edu.cn">
    
      <google-codelab-step label="1) 创建camera对象和canvas对象" duration="0">
        <p>   用小程序实现人物的姿态检测功能</p>
<p>   Camera对象实时获取图像，传送给后台模型处理，处理完的结果在canvas对象内显示</p>
<pre><code>1.  添加camera
2.  调整camera为全屏
3.  在&lt;camera&gt;...&lt;/camera&gt;中添加canvas对象
</code></pre>
<p>   进入下图目录，如果内有默认填充的代码可以清理掉</p>
<p>   创建camera对象，并添加一些属性，如后置摄像头、关闭闪光灯、相关报错、样式：全屏。<br></p>
<p>   进入index.wxss页面，同样的先将无关内容删除。<br></p>
<p>   添加样式,发现已经设置过样式（小程序初始化的样式）。<br></p>
<p>   进入app.wxss页面，将padding后的值修改为0，然后保存。如果出现提示点Ok就行。<br></p>
<p>   然后就可以在模拟器上，看到自己的头像出现（手动打码）<br></p>
<p>   进入index.js页面，来添加一些代码，使得我们能获取camera得到的一帧一帧的图片。<br></p>
<p>   进入index.wxml页面添加canvas对象<br></p>
<p>   回到index.js页面，添加红线部分代码，传入canvas对象<br></p>


      </google-codelab-step>
    
      <google-codelab-step label="引入模型" duration="0">
        <p>   进入下面的网址，直接调用谷歌提供的模型作为案例。</p>
<p>   <br>https://tensorflow.google.cn/</p>
<p>   <br>点击学习–&gt;针对javascript–&gt;查看模型</p>
<p>   以PoseNet模型为例，该模型能够对人物的姿态进行检测<br></p>
<p>   可以点击进入github页面，查看该模型的一些介绍和用法。<br></p>
<p>   <br>进入PowerShell(管理员)指令界面，进入到项目目录下开始安装该模型。</p>
<p>   <br>npm install @tensorflow-models/posenet</p>
<p>   <br>安装之后，返回小程序项目重新点击构建npm</p>
<p>   <br>回到index.js页面，导入模型，没报错就证明导入成功。</p>


      </google-codelab-step>
    
      <google-codelab-step label="异步加载" duration="0">
        <p>   这里有个问题需要注意，一些模型可能比较大，加载较慢，所以一般采用异步加载，但小程序不支持异步加载，要再安装一个库。回到PowerShell(管理员)指令界面，输入:</p>
<pre><code>npm install regenerator-runtime
</code></pre>
<p>   <br>之后回到小程序项目做一些修改，点击右上角详情–&gt;本地设置–&gt;取消es6转es5，如果&#39;使用npm模块&#39;没勾选的，现在勾选上</p>
<p>   修改代码部分就不累赘了，一些说明直接注释在代码旁边。将index.js内的所有代码替换为下方的代码。</p>
<pre><code>const posenet=require(&#39;@tensorflow-models/posenet&#39;)//模型的下载命名
const regeneratorRuntime=require(&#39;regenerator-runtime&#39;)//异步加载库的下载命令
//index.js
Page({
  //async 异步加载 ，onLoad是在加载时触发可能会造成卡顿，改为onReady加载完毕后触发
  async onReady() {
    const camera = wx.createCameraContext(this)//调用接口
    this.convas = wx.createCanvasContext(&#34;pose&#34;, this)
    this.net=await posenet.load({
      architecture: &#39;MobileNetV1&#39;,  //模型架构
      outputStride: 16,             //cnn中的stride参数
      inputResolution: 193,         //输入形状
      multiplier: 0.5               //层数
    })//加载模型，配置参数，详细的参数说明可以查看那个模型的github页面下的说明
    //console.log(this.net)   //该行代码用于检测模型是否加载成功
    let count=0
    const listener=camera.onCameraFrame((frame) =&gt; {
      count++
      if(count===4){
        //console.log(frame)
        count=0
      }
      
    })//监听器，每帧刷新时都会把监听器得到的信息通过fram传给我们.这里设置了每隔4帧
  listener.start()
 
  }
})

</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="可能遇到的问题" duration="0">
        <p>   碰上不合法域名问题，是因为模型的下载不是在本地而是从google的网址上下载的，微信小程序为了保障安全，涉及到新的域名都要在个人的微信小程序页面添加。</p>
<p>   回到微信小程序官网，登录自己的账号，操作如下图</p>
<p>   根据报错，把相应网址添加到request里，保存提交即可<br></p>
<p>   如果无法提交，提示域名未经过ICP备案，在详情里勾选不检测域名。这样就能在测试的时候访问该域名，如果要发布正式的微信小程序就得将模型放在已经备案的域名上。<br></p>
<p>   最后点击保存，在控制台能够查看模型信息即表示模型加载成功。<br></p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
